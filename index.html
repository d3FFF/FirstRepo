<html>
<head>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<style>
body {
  font-family: "Noto Sans KR", sans-serif;
  background: url('https://priconne-redive.jp/ele-wp/wp-content/uploads/2020/04/c73868cb5429b263bde6c06a2855767f.jpg') no-repeat;
  background-size: cover;
  width: 100%;
  margin: 0;
  text-align: center;
}

section {
  display: inline-block;
  text-align: center;
  background: #fff;
  padding: 20px;
  opacity: .8;
}

h1 {
  font-size: 24pt;
}

#result {
  size: 15pt;
}

h2.ServerOpen::before {
  content: '응!';
  color: #50B8E7;
  font-weight: bold;
}

h2.ServerOpenWithNotice::before {
  content: '응!';
  color: #50B8E7;
  font-weight: bold;
}

h2.InvalidAppInfo::before {
  content: '데이터를 못받아왔어';
  color: red;
  font-weight: bold;
}

h2.ServiceStatusNotOpen::before {
  content: '아니';
  color: red;
  font-weight: bold;
}

h2.NoticeCloseTerminate::before {
  content: '아니';
  color: red;
  font-weight: bold;
}

h2.NoticeCloseTerminateOutOfTime::before {
  content: '아니';
  color: red;
  font-weight: bold;
}

h2.ServiceStatusNotOpen::before {
  content: '아니';
  color: red;
  font-weight: bold;
}

</style>
<body>
<iframe width=1 height=1 style="visibility: hidden;" allow="autoplay"></iframe>
<section>
  <h1>프리코네 지금 열렸니? (<span id="time"></span> 기준)</h1>
  <h2 id="result"></h2>
  <span id="detail"></span>
</section>
</body>
<script>
let prevStatus = 0;

function setServerStatus(status) {
  setResult(status);

  if (status !== prevStatus) {
    if (status === 1) {
      playBGM();
    } else {
      stopBGM();
    }
  }
  prevStatus = status;
}

/*
* -4: 데이터 받아오기 실패
* -3: 서버 오픈 안함 (svcStatus가 open이 아님)
* -2: notices 존재, close 누르면 terminate
* -1: notices 존재, close 누르면 terminate (서버 점검 직전 or 연장 점검?)
*  0: 미결정
*  1: 서버 오픈 (notice 없음)
*  2: 서버 오픈 (notices 존재)
*/

function setResult(result) {
  let statusName = '';
  switch(result) {
    case -4:
    statusName = 'InvalidAppInfo'
    break;
    case -3:
    statusName = 'ServiceStatusNotOpen'
    break;
    case -2:
    statusName = 'NoticeCloseTerminate';
    break;
    case -1:
    statusName = 'NoticeCloseTerminateOutOfTime';
    break;
    case 0:
    statusName = '';
    break;
    case 1:
    statusName = 'ServerOpen';
    break;
    case 2:
    statusName = 'ServerOpenWithNotice';
    break;
  }

  document.querySelector('#result').className = statusName;
}

function setDetail(text) {
  document.querySelector('#detail').innerText = text;
}

function setTime(text) {
  document.querySelector('#time').innerText = text;
}

function getNoticeArray(data) {
  if (!data || !data.content || !data.content.notices) return [];
  return data.content.notices;
}

function getNotice(data) {
  const notices = getNoticeArray(data);
  if (notices.length && notices[0].msg)
    return notices[0].msg;
  else
    return '';
}

function getServerOpened(data) {
  const notices = getNoticeArray(data);
  const currTime = new Date().getTime();

  if (!data || !data.content) return -4;
  if (data.content.svcStatus !== 'open') return -3;

  if (notices[0]) {
    if (notices[0].actionOnClose === 'terminate') {
      if (notices[0].periodBeginTime >= currTime &&
          notices[0].periodEndTime <= currTime) {
            return -2;
          } else {
            return -1;
          }
    } else {
      return 2;
    }
  } else {
    return 1;
  }
}

function playBGM() {
  document.querySelector('iframe').src = 'https://www.youtube.com/embed/9l-VZC3UGXA?ecver=1&amp;autoplay=1&amp;iv_load_policy=1&amp;yt:stretch=16:9&amp;loop=1&amp;autohide=1';
}

function stopBGM() {
  document.querySelector('iframe').src = '';
}

function getCurrentTime() {
  const date = new Date();
  return ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2);
}

async function checkOpen() {
  const resp = await fetch('https://infodesk-zinny3.game.kakao.com/v2/app?appId=235375&appVer=2.0.11&market=googlePlay&sdkVer=3.10.2&os=android&lang=ko&osVer=6.0.1&country=kr');
  const data = await resp.json();

  const currTime = getCurrentTime();
  const noticeMsg = getNotice(data);
  const isServerOpened = getServerOpened(data);

  setTime(currTime);
  setDetail(noticeMsg);
  setServerStatus(isServerOpened);
}

document.addEventListener('DOMContentLoaded', () => {
  checkOpen();
  setInterval(() => checkOpen(), 30000);
});
</script>
</html>
